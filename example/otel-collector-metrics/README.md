# OpenTelemetry Collector Metrics Example

This example illustrates how to export metric data from
the OpenTelemetry-Go SDK to the OpenTelemetry Collector.
From there, we bring the the metric data to Prometheus
The complete flow is:

```

App + SDK ---> OpenTelemetry Collector -----> Prometheus (metrics)
                                          
```

# Prerequisites

You will need access to a Kubernetes cluster for this demo. We use a local
instance of [kind](https://kind.sigs.k8s.io/), but please feel free to pick
your favorite. If you do decide to use kind, please ensure that docker is installed.

The installation of kind can be found in [installation](https://kind.sigs.k8s.io/docs/user/quick-start/#installation)

For simplicity, the demo application is not part of the k8s cluster, and will
access the OpenTelemetry Collector through a NodePort on the cluster. Note that
the NodePort opened by this demo is not secured.

Ideally you'd want to either have your application running as part of the
kubernetes cluster, or use a secured connection (NodePort/LoadBalancer with TLS
or an ingress extension).

# Start k8s cluster

If you use kind, you should start a local cluster with a configuration [file](./k8s/kind.yaml).

In the configuration file, we use `extraPortMappings` feature to expose the port of collector to kind nodes.

By doing this, the demo program is able to send metric data to collector in the kind cluster.

```bash
kind create cluster --config k8s/kind.yaml
```

After a few minutes, a local k8s cluster with one node is started. You can following command to visit cluster directly.

```bash
$ kubectl get node
NAME                 STATUS   ROLES                  AGE   VERSION
otel-control-plane   Ready    control-plane,master   42h   v1.23.4
```

# Deploying prometheus

This demo uses [prometheus-operator](https://prometheus-operator.dev/) to deploy prometheus.

## Setting up the Prometheus operator

You can deploy the prometheus-operator through [prometheus-operator](https://github.com/prometheus-operator/kube-prometheus) project.

```bash
git clone https://github.com/prometheus-operator/prometheus-operator.git
# registry crds
kubectl create -f prometheus-operator/example/prometheus-operator-crd

# deploy prometheus-operator deployment
kubectl create -f prometheus-operator/example/rbac/prometheus-operator-crd
kubectl create -f prometheus-operator/example/rbac/prometheus-operator
```

## Setting up the Prometheus server

```bash
kubectl create -f k8s/prometheus.yaml
```

# Deploy the OpenTelemetry Collector

```bash
kubectl create -f k8s/otel-collector.yaml
```

The otel-collector will expose port `30080` on your cluster's node. By doing so, it makes it possible for us to access the Collector by using the static address `<node-ip>:30080`. In case you are running a local cluster, this will be `localhost:30080`. Note that you can also change this to a LoadBalancer or have an ingress extension for accessing the service.

# Running the demo code

You can find the complete code for this example in the [main.go](./main.go)
file. To run it, ensure you have a somewhat recent version of Go (preferably >=
1.13) and do

```bash
go run main.go
```

The example simulates an application, hard at work, computing for ten seconds
then finishing.

# Viewing instrumentation data

Now the exciting part! Let's check out the telemetry data generated by our
sample application

## Prometheus

Unfortunately, the Prometheus operator doesn't provide a convenient
out-of-the-box ingress route for us to use, so we'll use port-forwarding
instead. Note: this is a quick-and-dirty solution for the sake of example.
You *will* be attacked by shady people if you do this in production!

```bash
kubectl port-forward svc/prometheus-operated 9090
```

Then navigate to [http://localhost:9090](http://localhost:9090) to view
the Prometheus dashboard.

You can view the metrics in demo 'an_important_metric' through [url](http://localhost:9090/graph?g0.expr=an_important_metric&g0.tab=1&g0.stacked=0&g0.show_exemplars=0&g0.range_input=1h)